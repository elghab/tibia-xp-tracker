<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Yonexus - Tibia Fansite</title>
  <meta name="description" content="Yonexus - Tibia Fansite" />

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />

  <style>
    :root{
      --bg:#020617;--border:#1e293b;--text:#e5e7eb;--muted:#94a3b8;--accent:#facc15;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Inter,sans-serif;background:var(--bg);color:var(--text)}

    .navbar{
      position:fixed;top:0;width:100%;padding:1.5rem 5%;
      background:rgba(2,6,23,.95);border-bottom:1px solid var(--border);
      display:flex;justify-content:space-between;align-items:center;z-index:1000;
    }
    .logo{
      font-size:2rem;font-weight:700;
      background:linear-gradient(135deg,var(--accent),#eab308);
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;
    }
    .cta-btn{
      padding:12px 28px;border:none;border-radius:50px;font-weight:700;cursor:pointer;
      background:linear-gradient(135deg,var(--accent),#eab308);color:#020617;
    }

    .hero{min-height:100vh;display:flex;align-items:center;justify-content:center;text-align:center;padding:0 5%}
    .hero h1{
      font-size:4rem;background:linear-gradient(135deg,var(--accent),#fff);
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;
    }
    .hero p{color:var(--muted);margin-top:1rem;font-size:1.2rem}

    .hero-actions{margin-top:3rem;display:flex;gap:1.5rem;justify-content:center;flex-wrap:wrap}
    .action-card{
      min-width:200px;padding:1.5rem 2rem;border-radius:20px;
      background:rgba(2,6,23,.7);border:1px solid var(--border);
      color:var(--text);text-decoration:none;text-align:center;font-weight:700;transition:.3s;
    }
    .action-card span{font-size:2rem;display:block;margin-bottom:.6rem}
    .action-card:hover{
      transform:translateY(-6px);border-color:var(--accent);
      box-shadow:0 15px 35px rgba(250,204,21,.25);color:var(--accent);
    }

    .auth-modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);backdrop-filter:blur(10px);z-index:2000;align-items:center;justify-content:center;padding:20px}
    .auth-container{
      width:100%;max-width:520px;background:#020617;border:2px solid var(--border);
      border-radius:20px;overflow:hidden;max-height:90vh;display:flex;flex-direction:column
    }
    .auth-header{display:flex;justify-content:space-between;align-items:center;padding:1rem 1.5rem;border-bottom:1px solid var(--border)}
    .auth-close{background:none;border:none;font-size:1.8rem;color:var(--muted);cursor:pointer}
    .auth-close:hover{color:var(--accent)}
    .auth-tabs{display:flex}
    .tab-btn{flex:1;padding:1rem;background:none;border:none;color:var(--muted);cursor:pointer;font-weight:700}
    .tab-btn.active{color:var(--accent);background:rgba(250,204,21,.1)}
    .auth-content{padding:2rem;overflow-y:auto}
    .tab-panel{display:none}
    .tab-panel.active{display:block;animation:fade .3s ease}
    @keyframes fade{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:none}}

    .form-group{margin-bottom:1.1rem;text-align:left}
    .form-group label{display:block;font-size:.85rem;color:var(--muted);margin-bottom:.4rem}
    .form-group input,.form-group select{
      width:100%;padding:.9rem 1rem;border-radius:12px;border:2px solid var(--border);
      background:rgba(255,255,255,.05);color:var(--text);outline:none;
    }
    .form-group small{color:var(--muted);display:block;margin-top:6px;font-size:.82rem;line-height:1.2rem}
    .submit-btn{
      width:100%;padding:1rem;border:none;border-radius:12px;
      background:linear-gradient(135deg,var(--accent),#eab308);font-weight:800;cursor:pointer;margin-top:.5rem;color:#020617;
    }

    .flash{
      margin:14px 0 0;padding:12px 14px;border:1px solid rgba(239,68,68,.35);
      border-radius:12px;background:rgba(239,68,68,.12);color:#fecaca;font-weight:800;
    }

    .hint{margin-top:6px;font-size:.82rem;color:var(--muted)}
    .inline-row{display:flex;gap:10px;align-items:center;justify-content:space-between}
    .pill{font-size:.78rem;border:1px solid var(--border);padding:6px 10px;border-radius:999px;color:var(--muted)}

    /* overlay loading */
    .loading-overlay{position:fixed;inset:0;background:rgba(0,0,0,.65);display:none;align-items:center;justify-content:center;z-index:9999}
    .loading-box{display:flex;flex-direction:column;gap:12px;align-items:center;padding:18px 20px;border-radius:14px;border:1px solid var(--border);background:rgba(2,6,23,.92);color:var(--text);min-width:220px}
    .spinner{width:34px;height:34px;border-radius:50%;border:4px solid rgba(255,255,255,.18);border-top-color:var(--accent);animation:spin .9s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>

<body>
  <nav class="navbar">
    <div class="logo">Yonexus</div>

    {% if current_user.is_authenticated %}
      <div style="display:flex; gap:12px; align-items:center;">
        <div style="font-weight:700; color: var(--muted);">
          Bem Vindo <span style="color:var(--accent)">{{ current_user.username }}</span> !
        </div>
        <form method="POST" action="/logout" style="margin:0;">
          <button class="cta-btn" type="submit">Sair</button>
        </form>
      </div>
    {% else %}
      <button class="cta-btn" id="openModal" type="button">Entrar / Registrar</button>
    {% endif %}
  </nav>

  <section class="hero">
    <div>
      <h1>Yonexus</h1>
      <p>F√£ site de tibia ainda em desenvolvimento.</p>

      <div class="hero-actions">
        <a href="/xp-tracker" class="action-card"><span>üìà</span>XP Tracker</a>
        <a href="/bestiary" class="action-card"><span>üìö</span>Besti√°rio</a>
        <a href="#" class="action-card"><span>üì∞</span>Not√≠cias</a>
      </div>
    </div>
  </section>

  <!-- MODAL -->
  <div id="authModal" class="auth-modal">
    <div class="auth-container">
      <div class="auth-header">
        <strong>Conta Yonexus</strong>
        <button class="auth-close" id="closeModal" type="button">&times;</button>
      </div>

      <div class="auth-tabs">
        <button class="tab-btn active" data-tab="login" type="button">Entrar</button>
        <button class="tab-btn" data-tab="register" type="button">Criar Conta</button>
      </div>

      <div class="auth-content">
        <!-- LOGIN -->
        <div id="loginTab" class="tab-panel active">
          {% with messages = get_flashed_messages() %}
            {% if messages %}
              <div class="flash">{{ messages[-1] }}</div>
            {% endif %}
          {% endwith %}

          <form method="POST" action="/login">
            <div class="form-group">
              <label>Usu√°rio ou email</label>
              <input name="username" type="text" required />
            </div>

            <div class="form-group">
              <label>Senha</label>
              <input name="password" type="password" required />
            </div>

            <button class="submit-btn" type="submit">Entrar</button>
          </form>
        </div>

        <!-- REGISTER -->
        <div id="registerTab" class="tab-panel">
          <form method="POST" action="/register" id="registerForm">
            <div class="form-group">
              <label>Usu√°rio</label>
              <input name="username" type="text" required />
            </div>

            <div class="form-group">
              <label>Email</label>
              <input name="email" type="email" required />
            </div>

            <div class="form-group">
              <label>Senha</label>
              <input name="password" type="password" required />
            </div>

            <hr style="border:0; border-top:1px solid var(--border); margin:18px 0;" />

            <div class="form-group">
              <label>Nome do personagem</label>
              <!-- ‚úÖ name alinhado com o app.py -->
              <input name="char_name" id="regCharName" type="text" placeholder="Ex: Roth Lion" required />
              <div class="inline-row" style="margin-top:8px;">
                <div class="hint" id="charFetchStatus"></div>
                <div class="pill" id="charLevelPill" style="display:none;"></div>
              </div>
            </div>

            <div class="form-group">
              <label>XP inicial (autom√°tico)</label>
              <!-- ‚úÖ name alinhado com o app.py -->
              <input name="xp_start" id="regXpStart" type="text" readonly />
              <small>XP do n√≠vel atual do personagem. (pode mudar depois.) </small>
            </div>

            <div class="form-group">
              <label>N√≠vel meta (m√≠nimo: n√≠vel atual + 1)</label>
              <!-- ‚úÖ name alinhado com o app.py -->
              <select id="registerGoalLevel" name="goal_level" required>
                <option value="">Carregando...</option>
              </select>
              <small id="registerGoalPreview"></small>
            </div>

            <div class="form-group">
              <label>Meta de xp di√°ria</label>
              <!-- ‚úÖ name alinhado com o app.py -->
              <input name="daily_goal" id="regDailyGoal" type="text" value="1.000.000" />
              <small>Padr√£o: 1.000.000 (voc√™ pode mudar depois nas configura√ß√µes).</small>
            </div>

            <button class="submit-btn" type="submit" id="registerSubmit">Criar Conta</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- OVERLAY LOADING -->
  <div id="loadingOverlay" class="loading-overlay" aria-busy="false">
    <div class="loading-box">
      <div class="spinner"></div>
      <div id="loadingText">Carregando...</div>
    </div>
  </div>

  <script>
    const authModal = document.getElementById("authModal");
    const openModal = document.getElementById("openModal");
    const closeModal = document.getElementById("closeModal");

    function openAuthModal() {
      if (!authModal) return;
      authModal.style.display = "flex";
      // quando abrir, j√° prepara defaults do cadastro
      initRegisterDefaults();
    }

    function closeAuthModal() {
      if (!authModal) return;
      authModal.style.display = "none";
    }

    if (openModal) openModal.onclick = openAuthModal;
    if (closeModal) closeModal.onclick = closeAuthModal;

    window.onclick = (e) => {
      if (e.target === authModal) closeAuthModal();
    };

    document.querySelectorAll(".tab-btn").forEach(btn => {
      btn.onclick = () => {
        if (btn.classList.contains("active")) return;
        document.querySelectorAll(".tab-btn, .tab-panel").forEach(el => el.classList.remove("active"));
        btn.classList.add("active");
        document.getElementById(btn.dataset.tab + "Tab").classList.add("active");
        if (btn.dataset.tab === "register") initRegisterDefaults();
      };
    });

    // Se houver flash (ex.: login inv√°lido), abre o modal e fica na aba login
    const hasFlash = {{ 'true' if get_flashed_messages() else 'false' }};
    if (hasFlash) {
      openAuthModal();
      document.querySelectorAll(".tab-btn, .tab-panel").forEach(el => el.classList.remove("active"));
      document.querySelector('.tab-btn[data-tab="login"]').classList.add("active");
      document.getElementById("loginTab").classList.add("active");
    }

    // -------- Helpers cadastro ----------
    function showLoading(text = "Carregando...") {
      const overlay = document.getElementById("loadingOverlay");
      const label = document.getElementById("loadingText");
      if (!overlay) return;
      if (label) label.textContent = text;
      overlay.style.display = "flex";
      overlay.setAttribute("aria-busy", "true");
    }
    function hideLoading() {
      const overlay = document.getElementById("loadingOverlay");
      if (!overlay) return;
      overlay.style.display = "none";
      overlay.setAttribute("aria-busy", "false");
    }

    let xpTableCache = null;

    function fmt(n) {
      return Number(n).toLocaleString("pt-BR");
    }

    function digitsOnly(str) {
      return String(str || "").replace(/\D/g, "");
    }

    function setStatus(msg, type) {
      const el = document.getElementById("charFetchStatus");
      if (!el) return;
      el.textContent = msg || "";
      el.style.color = type === "err" ? "#ef4444" : (type === "ok" ? "#22c55e" : "var(--muted)");
    }

    async function loadXpTable() {
      if (xpTableCache) return xpTableCache;
      showLoading("Carregando tabela de n√≠veis...");
      try {
        const res = await fetch("/xp-table");
        xpTableCache = await res.json();
        return xpTableCache;
      } finally {
        hideLoading();
      }
    }

    function xpForLevelFromTable(level) {
      const row = (xpTableCache || []).find(r => Number(r.level) === Number(level));
      return row ? Number(row.experience) : null;
    }

    function updateGoalPreview() {
      const sel = document.getElementById("registerGoalLevel");
      const preview = document.getElementById("registerGoalPreview");
      if (!sel || !preview || !xpTableCache) return;
      if (!sel.value) { preview.textContent = ""; return; }
      const lvl = Number(sel.value);
      const xp = xpForLevelFromTable(lvl);
      preview.textContent = xp !== null ? `XP total no n√≠vel: ${fmt(xp)}` : "";
    }

    function populateGoalSelect(minLevelExclusive, suggestedLevel) {
      const sel = document.getElementById("registerGoalLevel");
      if (!sel || !xpTableCache) return;

      sel.innerHTML = "";

      const optEmpty = document.createElement("option");
      optEmpty.value = "";
      optEmpty.textContent = "Selecione...";
      sel.appendChild(optEmpty);

      xpTableCache.forEach(row => {
        const lvl = Number(row.level);
        const opt = document.createElement("option");
        opt.value = String(lvl);
        opt.textContent = `Level ${lvl}`;
        if (minLevelExclusive !== null && minLevelExclusive !== undefined && lvl <= Number(minLevelExclusive)) {
          opt.disabled = true;
        }
        sel.appendChild(opt);
      });

      if (suggestedLevel) sel.value = String(suggestedLevel);
      sel.onchange = updateGoalPreview;
      updateGoalPreview();
    }

    async function fetchCharacterLevel(charName) {
      const url = `https://api.tibiadata.com/v4/character/${encodeURIComponent(charName)}`;
      showLoading("Buscando personagem...");
      try {
        const r = await fetch(url);
        const j = await r.json();
        return Number(j.character.character.level);
      } finally {
        hideLoading();
      }
    }

    async function initRegisterDefaults() {
      await loadXpTable();

      const daily = document.getElementById("regDailyGoal");
      if (daily && !daily.value) daily.value = "1.000.000";

      populateGoalSelect(null, null);

      const charInput = document.getElementById("regCharName");
      if (!charInput) return;

      // bind uma vez
      if (charInput.dataset.bound === "1") return;
      charInput.dataset.bound = "1";

      charInput.addEventListener("blur", async () => {
        const name = charInput.value.trim();
        if (!name) return;

        setStatus("Buscando personagem...", "muted");

        const submit = document.getElementById("registerSubmit");
        if (submit) submit.disabled = true;

        try {
          const level = await fetchCharacterLevel(name);

          const pill = document.getElementById("charLevelPill");
          if (pill) {
            pill.style.display = "inline-block";
            pill.textContent = `Level atual: ${level}`;
          }

          const xpStart = xpForLevelFromTable(level);
          const xpStartEl = document.getElementById("regXpStart");
          if (xpStartEl) xpStartEl.value = xpStart !== null ? fmt(xpStart) : "";

          populateGoalSelect(level, level + 10);

          // escolhe o primeiro n√≠vel habilitado automaticamente
          const sel = document.getElementById("registerGoalLevel");
          if (sel) {
            const firstAllowed = [...sel.options].find(o => o.value && !o.disabled);
            if (firstAllowed) sel.value = firstAllowed.value;
            updateGoalPreview();
          }

          setStatus("Personagem encontrado.", "ok");
        } catch (e) {
          setStatus("N√£o foi poss√≠vel encontrar esse personagem. Verifique o nome.", "err");
        } finally {
          if (submit) submit.disabled = false;
        }
      });

      // antes de enviar: remove pontos (1.000.000 -> 1000000)
      const form = document.getElementById("registerForm");
      if (form && form.dataset.bound !== "1") {
        form.dataset.bound = "1";
        form.addEventListener("submit", () => {
          const xpStartEl = document.getElementById("regXpStart");
          if (xpStartEl) xpStartEl.value = digitsOnly(xpStartEl.value);

          const dailyEl = document.getElementById("regDailyGoal");
          if (dailyEl) dailyEl.value = digitsOnly(dailyEl.value);
        });
      }
    }
  </script>
</body>
</html>
