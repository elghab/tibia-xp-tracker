<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Yonexus - XP Tracker</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<head>
<style>
  /* Centraliza√ß√£o do bot√£o do meio no header */
  .tracker-left { flex: 1; }
  .tracker-center { flex: 1; display: flex; justify-content: center; align-items: center; }
  .tracker-right { flex: 1; justify-content: flex-end; /* mant√©m o display:flex do style.css file4 */ }

  .char-line { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
  .vip-badge {
    padding: 6px 10px; border-radius: 999px; font-size: 12px; font-weight: 700;
    letter-spacing: .4px; border: 1px solid rgba(255,255,255,.12); line-height: 1;
  }
  .vip-on { background: rgba(250, 204, 21, 0.18); color: #facc15; border-color: rgba(250, 204, 21, 0.45); }
  .vip-off { background: rgba(148, 163, 184, 0.12); color: #94a3b8; border-color: rgba(148, 163, 184, 0.25); }

  .char-tools { margin-top: 6px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
  .char-tools select { padding: 8px 10px; border-radius: 10px; border: 1px solid rgba(255,255,255,.12); background: rgba(2,6,23,.7); color: #e5e7eb; outline: none; }

  .flash-wrap { margin: 12px auto 0; max-width: 1100px; padding: 0 16px; }
  .flash-msg { background: rgba(239, 68, 68, 0.12); border: 1px solid rgba(239, 68, 68, 0.25); color: #fecaca; padding: 10px 12px; border-radius: 12px; font-weight: 600; margin-bottom: 10px; }

  .form-group { margin-top: 12px; }
  .form-group label { display: block; margin-bottom: 6px; opacity: .9; }
  .form-group input, .form-group select { width: 100%; padding: 10px 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,.12); background: rgba(2,6,23,.7); color: #e5e7eb; outline: none; }
  .form-row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  @media (max-width: 720px) { .form-row-2 { grid-template-columns: 1fr; } }
  .form-inline-help { margin-top: 6px; font-size: 12px; opacity: .8; }
  .char-preview { margin-top: 10px; padding: 10px 12px; border-radius: 12px; background: rgba(59, 130, 246, 0.10); border: 1px solid rgba(59, 130, 246, 0.25); }
  .error-text { margin-top: 10px; padding: 10px 12px; border-radius: 12px; background: rgba(239, 68, 68, 0.12); border: 1px solid rgba(239, 68, 68, 0.25); color: #fecaca; font-weight: 600; }
  .modal-actions { display: flex; gap: 10px; margin-top: 14px; }
  .modal-actions button { flex: 1; }
</style>
<body>
  <!-- LOADING OVERLAY -->
  <div id="loadingOverlay" class="loading-overlay" aria-busy="false">
    <div class="loading-box">
      <div class="spinner"></div>
      <div id="loadingText">Carregando...</div>
    </div>
  </div>

  <!-- TOAST -->
  <div id="toast" class="toast"></div>

  <!-- HEADER -->
  <header class="header">
    <div class="tracker-header">
      <div class="tracker-left">
        <div class="char-line">
          <h2 id="charName">Personagem</h2>
          {% if current_user.is_vip() %}
            <span class="vip-badge vip-on">
              VIP ATIVO
              {% if current_user.vip_until %}
                (at√© {{ current_user.vip_until.strftime("%d/%m/%Y") }})
              {% endif %}
            </span>
          {% else %}
            <span class="vip-badge vip-off">CONTA FREE</span>
          {% endif %}
        </div>
        <div id="info" class="tracker-info">Voca√ß√£o | Level | Mundo</div>
        <div class="char-tools">
          <form action="{{ url_for('characters_select') }}" method="post">
            <select name="character_id" onchange="this.form.submit()">
              {% for c in current_user.characters %}
                <option value="{{ c.id }}" {% if current_user.active_character_id == c.id %}selected{% endif %}>
                  {{ c.char_name }}
                </option>
              {% endfor %}
            </select>
          </form>
          {% if current_user.characters|length == 1 %}
            <form action="{{ url_for('characters_delete') }}" method="post" onsubmit="return confirm('Excluir este personagem e todo o hist√≥rico dele?')">
              <input type="hidden" name="character_id" value="{{ current_user.active_character_id }}">
              <button type="submit" class="btn-logout-tracker">Excluir</button>
            </form>
          {% endif %}
          {% if current_user.is_vip() %}
            <button type="button" class="btn-settings" onclick="openAddChar()">+ Personagem</button>
          {% endif %}
        </div>
      </div>

      <!-- BOTO CENTRAL (√°rea verde do print) -->
      <div class="tracker-center">
        <!-- CHAT DESATIVADO (comentado conforme pedido anterior) -->
        <!-- <button class="btn-settings" onclick="window.location.href='{{ url_for('chat') }}'">Chat</button> -->
      </div>

      <div class="tracker-right">
        <button class="btn-metrics" onclick="window.location.href='/more-metrics'">Mais m√©tricas</button>
        <button class="btn-settings" onclick="openSettings()">
          <span><span>Configura√ß√µes</span></span>
        </button>
        <form action="{{ url_for('logout') }}" method="post" class="logout-form">
          <button type="submit" class="btn-logout-tracker">Sair</button>
        </form>
      </div>
    </div>
  </header>

  <!-- FLASH mensagens do backend -->
  <div class="flash-wrap">
    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <div class="flash-msg">{{ messages[0] }}</div>
      {% endif %}
    {% endwith %}
  </div>

  <main class="container">
    <!-- STATS -->
    <section class="stats-grid">
      <div class="card highlight">
        <span>XP Atual</span>
        <h2 id="xp">0</h2>
      </div>
      <div class="card">
        <span>XP Restante</span>
        <h2 id="remaining">0</h2>
      </div>
      <div class="card">
        <span>M√©dia XP/dias</span>
        <h2 id="avg">0</h2>
      </div>
      <div class="card">
        <span>Estimativa de dias</span>
        <h2 id="eta">0</h2>
      </div>
    </section>

    <!-- === NOVO: PROGRESSO GERAL (N√çVEL META) === -->
    <section class="daily-goal" id="overallGoalSection">
      <h3 id="overallTitle">Progresso at√© o n√≠vel meta</h3>

      <div class="entry-box" style="margin-top:10px; gap:10px; flex-wrap:wrap;">
        <label style="opacity:.9;font-weight:700">N√≠vel meta</label>
        <input id="goalLevelInline" type="number" min="1" placeholder="Ex: 200" style="max-width:180px">
        <button type="button" class="btn-settings" onclick="saveGoalLevelInline()">Salvar</button>
      </div>

      <div class="progress-bar" style="margin-top:12px">
        <div id="overallFill" class="fill"></div>
      </div>

      <p class="daily-text">
        <span id="overallPercent">0</span>% ‚Äî
        <span id="overallText">0 / 0 XP</span>
      </p>

      <p class="daily-remaining" id="overallRemaining"></p>
    </section>

    <!-- META DI√ÅRIA -->
    <section class="daily-goal">
      <h3 id="dailyTitle">Meta di√°ria</h3>

      <!-- === NOVO: EDITAR META DI√ÅRIA INLINE === -->
      <div class="entry-box" style="margin-top:10px; gap:10px; flex-wrap:wrap;">
        <label style="opacity:.9;font-weight:700">Meta di√°ria (XP)</label>
        <input id="dailyGoalInline" type="number" min="0" placeholder="Ex: 1000000" style="max-width:220px">
        <button type="button" class="btn-settings" onclick="saveDailyGoalInline()">Salvar</button>
      </div>

      <div id="goalWarning" class="extra-metrics" style="display:none">
        <h3>Aten√ß√£o</h3>
        <p>O n√≠vel atual do personagem j√° ultrapassou o n√≠vel meta configurado. Considere ajustar sua meta nas configura√ß√µes.</p>
      </div>

      <div id="goalReached" class="extra-metrics" style="display:none">
        <h3>Meta alcan√ßada!</h3>
        <p>Voc√™ atingiu ou ultrapassou a meta de XP configurada. Ajuste a meta para um novo objetivo.</p>
      </div>

      <div class="progress-bar">
        <div id="progressFill" class="fill"></div>
      </div>

      <p class="daily-text">
        <span id="dailyPercent">0</span>%
        <span id="dailyText">0 / 0 XP</span>
      </p>
      <p id="dailyRemaining" class="daily-remaining"></p>
    </section>

    <!-- ENTRADA DE XP -->
    <section class="entry">
      <h3>Registrar XP do dia</h3>
      <div class="entry-box">
        <input id="xpInput" type="text" placeholder="Ex: 250000">
        <button id="xpSubmitBtn" onclick="addXP()">Adicionar</button>
      </div>
      <label class="death-toggle">
        <input id="deathToggle" type="checkbox" onchange="updateXpMode()">
        <span class="skull"></span>
        <span>Marcar como morte (retirar XP)</span>
      </label>
    </section>

    <!-- GR√ÅFICO -->
    <section class="chart-section">
      <h3>Hist√≥rico de XP di√°rio</h3>
      <canvas id="chart" height="120"></canvas>
    </section>

    <section class="extra-metrics">
      <h3>Detalhes adicionais</h3>
      <p>Use o hist√≥rico para entender seus melhores dias de up e ajustar sua meta di√°ria.</p>
    </section>
  </main>

  <!-- FOOTER -->
  <footer class="footer">
    <p>Yonexus ü¶ã - site n√£o oficial de Tibia.</p>
  </footer>

  <!-- === MODAL CONFIGURA√á√ïES (SEM META DI√ÅRIA E SEM N√çVEL META) === -->
  <div id="settingsModal" class="modal">
    <div class="modal-content">
      <h2>Configura√ß√µes</h2>

      <label for="cfgName">Nome do personagem</label>
      <input id="cfgName" type="text">

      <div id="charChangeWarning" class="form-note" style="display:none">
        Ao alterar o nome do personagem e salvar, todo o hist√≥rico de XP ser√° zerado.
      </div>

      <label for="cfgStart">XP inicial</label>
      <input id="cfgStart" type="number">
      <div id="cfgStartNote" class="cfg-note"></div>

      <div class="modal-actions">
        <button type="button" onclick="resetXpHistory()">Zerar hist√≥rico</button>
        <button type="button" onclick="closeSettings()">Cancelar</button>
        <button type="button" class="save" onclick="saveSettings()">Salvar</button>
      </div>
    </div>
  </div>

  {% if current_user.is_vip() %}
    <!-- MODAL ADICIONAR PERSONAGEM VIP -->
    <div id="addCharModal" class="modal">
      <div class="modal-content">
        <h2>Adicionar personagem</h2>
        <p class="modal-subtitle">VIP: adicione outro personagem e alterne quando quiser.</p>

        <form action="{{ url_for('add_character') }}" method="post">
          <div class="form-group">
            <label>Nome do personagem Tibia</label>
            <input type="text" id="addCharName" name="char_name" required onblur="onAddCharNameBlur()">
            <div class="form-inline-help">Use o nome exato do personagem, incluindo espa√ßos.</div>
          </div>

          <div id="addCharPreview" class="char-preview" style="display:none"></div>
          <div id="addCharError" class="error-text" style="display:none"></div>

          <div class="form-row-2">
            <div class="form-group">
              <label>XP inicial (autom√°tico)</label>
              <input type="number" id="addXpStart" name="xpstart" min="0">
              <div class="form-inline-help">XP m√≠nimo do n√≠vel atual do personagem. Voc√™ pode ajustar para cima.</div>
            </div>

            <div class="form-group">
              <label>N√≠vel meta</label>
              <select id="addGoalLevel" name="goallevel"></select>
              <div class="form-inline-help">Deve ser maior que o n√≠vel atual.</div>
            </div>
          </div>

          <div class="form-group">
            <label>Meta de XP di√°ria</label>
            <input type="number" id="addDailyGoal" name="dailygoal">
            <div class="form-inline-help">Padr√£o 1.000.000 ‚Äî voc√™ pode mudar depois nas configura√ß√µes.</div>
          </div>

          <div class="form-group">
            <div id="addGoalXpPreview" class="form-inline-help"></div>
          </div>

          <button type="submit" id="addCharSubmitBtn" class="btn-settings" disabled>Adicionar</button>
        </form>

        <div class="modal-actions">
          <button type="button" onclick="closeAddChar()">Fechar</button>
        </div>
      </div>
    </div>
  {% endif %}

  <script src="{{ url_for('static', filename='js/main.js') }}"></script>

  {% if current_user.is_vip() %}
    <script>
      function openAddChar() {
        document.getElementById("addCharModal").style.display = "flex";
        const i = document.getElementById("addCharName");
        if (i) i.focus();
      }

      function closeAddChar() {
        document.getElementById("addCharModal").style.display = "none";
      }

      document.addEventListener("click", e => {
        const m = document.getElementById("addCharModal");
        if (m === e.target) closeAddChar();
      });

      async function fetchCharacterFromTibia(charName) {
        const url = `https://api.tibiadata.com/v4/character/${encodeURIComponent(charName)}`;
        const res = await fetch(url);
        if (!res.ok) throw new Error("Falha na API do Tibia.");
        const j = await res.json();
        if (!j || !j.character || !j.character.character) throw new Error("Personagem n√£o encontrado.");
        return j.character.character;
      }

      function xpForLevelFromTable(table, level) {
        const row = table.find(r => Number(r.level) === Number(level));
        return row ? Number(row.experience) : null;
      }

      async function updateAddGoalXpPreviewFromSelect(cachedTable) {
        const goalSelect = document.getElementById("addGoalLevel");
        const preview = document.getElementById("addGoalXpPreview");
        if (!goalSelect || !preview) return;
        try {
          const xpTable = cachedTable;
          const lvl = Number(goalSelect.value);
          const xp = xpForLevelFromTable(xpTable, lvl);
          preview.textContent = xp !== null ? `XP total no n√≠vel meta: ${xp.toLocaleString("pt-BR")}` : "";
        } catch {
          preview.textContent = "";
        }
      }

      async function onAddCharNameBlur() {
        const nameInput = document.getElementById("addCharName");
        const preview = document.getElementById("addCharPreview");
        const errorBox = document.getElementById("addCharError");
        const xpInput = document.getElementById("addXpStart");
        const goalSelect = document.getElementById("addGoalLevel");
        const submitBtn = document.getElementById("addCharSubmitBtn");

        const rawName = nameInput.value.trim();
        if (!rawName) {
          preview.style.display = "none";
          errorBox.style.display = "none";
          submitBtn.disabled = true;
          return;
        }

        preview.style.display = "none";
        errorBox.style.display = "none";
        submitBtn.disabled = true;
        goalSelect.innerHTML = "";
        xpInput.value = "";
        document.getElementById("addGoalXpPreview").textContent = "";

        try {
          showLoading("Buscando personagem...");
          const [charData, xpTable] = await Promise.all([
            fetchCharacterFromTibia(rawName),
            loadXpTable()
          ]);

          const lvl = Number(charData.level);
          const xpMin = xpForLevelFromTable(xpTable, lvl);
          if (xpMin === null) throw new Error("Tabela de XP n√£o possui o n√≠vel atual do personagem.");

          preview.innerHTML = `Personagem <strong>${charData.name}</strong><br>${charData.vocation} | Level ${charData.level} | ${charData.world}`;
          preview.style.display = "block";

          xpInput.min = String(xpMin);
          xpInput.value = xpMin;

          const daily = document.getElementById("addDailyGoal");
          if (!daily.value) daily.value = "1000000";

          goalSelect.innerHTML = "";
          xpTable.forEach(row => {
            const lv = Number(row.level);
            const opt = document.createElement("option");
            opt.value = String(lv);
            opt.textContent = `Level ${lv}`;
            if (lv === lvl) opt.disabled = true;
            goalSelect.appendChild(opt);
          });

          let desired = lvl + 10;
          const desiredRow = xpTable.find(r => Number(r.level) === desired);
          if (!desiredRow) {
            const firstValid = xpTable.find(r => Number(r.level) > lvl);
            desired = firstValid ? Number(firstValid.level) : lvl + 1;
          }
          goalSelect.value = String(desired);
          await updateAddGoalXpPreviewFromSelect(xpTable);

          submitBtn.disabled = false;
        } catch (err) {
          errorBox.textContent = err?.message || "N√£o foi poss√≠vel encontrar esse personagem na API.";
          errorBox.style.display = "block";
          preview.style.display = "none";
          submitBtn.disabled = true;
        } finally {
          hideLoading();
        }
      }

      document.addEventListener("change", async e => {
        if (e.target && e.target.id === "addGoalLevel") {
          await updateAddGoalXpPreviewFromSelect();
        }
      });
    </script>
  {% endif %}
</body>
</html>
